"""add_versioning_and_audit_log_tables_v4

Revision ID: f5360a39a33b
Revises: 73ffefc9df79
Create Date: 2025-07-05 10:41:01.396622

"""

from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = "f5360a39a33b"
down_revision: Union[str, Sequence[str], None] = "73ffefc9df79"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "audit_logs",
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("user_id", sa.Integer(), nullable=True),
        sa.Column(
            "action",
            sa.Enum("CREATE", "UPDATE", "DELETE", "LOGIN", "LOGOUT", "ACCESS", name="auditaction"),
            nullable=False,
        ),
        sa.Column("table_name", sa.String(), nullable=True),
        sa.Column("record_pk", sa.String(), nullable=True),
        sa.Column("changed_fields", sa.JSON(), nullable=True),
        sa.Column("comment", sa.Text(), nullable=True),
        sa.Column("ip_address", sa.String(), nullable=True),
        sa.Column("user_agent", sa.String(), nullable=True),
        sa.Column(
            "timestamp", sa.DateTime(timezone=True), server_default=sa.text("(CURRENT_TIMESTAMP)"), nullable=True
        ),
        sa.ForeignKeyConstraint(["user_id"], ["users.id"], ondelete="SET NULL"),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        "ix_audit_log_table_record_timestamp", "audit_logs", ["table_name", "record_pk", "timestamp"], unique=False
    )
    op.create_index(
        "ix_audit_log_user_action_timestamp", "audit_logs", ["user_id", "action", "timestamp"], unique=False
    )
    op.create_index(op.f("ix_audit_logs_action"), "audit_logs", ["action"], unique=False)
    op.create_index(op.f("ix_audit_logs_id"), "audit_logs", ["id"], unique=False)
    op.create_index(op.f("ix_audit_logs_record_pk"), "audit_logs", ["record_pk"], unique=False)
    op.create_index(op.f("ix_audit_logs_table_name"), "audit_logs", ["table_name"], unique=False)
    op.create_index(op.f("ix_audit_logs_timestamp"), "audit_logs", ["timestamp"], unique=False)
    op.create_index(op.f("ix_audit_logs_user_id"), "audit_logs", ["user_id"], unique=False)
    op.create_table(
        "strategy_versions",
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("strategy_id", sa.Integer(), nullable=False),
        sa.Column("version_number", sa.Integer(), nullable=False),
        sa.Column("name", sa.String(), nullable=False),
        sa.Column("description", sa.Text(), nullable=True),
        sa.Column("model_version", sa.String(), nullable=True),
        sa.Column("parameters", sa.JSON(), nullable=True),
        sa.Column(
            "changed_at", sa.DateTime(timezone=True), server_default=sa.text("(CURRENT_TIMESTAMP)"), nullable=True
        ),
        sa.ForeignKeyConstraint(["strategy_id"], ["strategies.id"], ondelete="CASCADE"),
        sa.PrimaryKeyConstraint("id"),
        sa.UniqueConstraint("strategy_id", "version_number", name="uq_strategy_id_version_number"),
    )
    op.create_index("ix_strategy_version_strategy_id", "strategy_versions", ["strategy_id"], unique=False)
    op.create_index(op.f("ix_strategy_versions_id"), "strategy_versions", ["id"], unique=False)
    op.create_index(op.f("ix_strategy_versions_strategy_id"), "strategy_versions", ["strategy_id"], unique=False)
    op.create_table(
        "trade_versions",
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("trade_id", sa.Integer(), nullable=False),
        sa.Column("version_number", sa.Integer(), nullable=False),
        sa.Column("user_id", sa.Integer(), nullable=True),
        sa.Column("order_id", sa.Integer(), nullable=True),
        sa.Column("symbol", sa.String(), nullable=False),
        sa.Column("trade_type", sa.Enum("BUY", "SELL", name="tradetype"), nullable=False),
        sa.Column("quantity", sa.Numeric(precision=19, scale=8), nullable=False),
        sa.Column("price", sa.Numeric(precision=19, scale=8), nullable=False),
        sa.Column("executed_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("commission", sa.Numeric(precision=19, scale=8), nullable=True),
        sa.Column(
            "changed_at", sa.DateTime(timezone=True), server_default=sa.text("(CURRENT_TIMESTAMP)"), nullable=True
        ),
        sa.Column("change_reason", sa.Text(), nullable=True),
        sa.Column("changes", sa.JSON(), nullable=True),
        sa.ForeignKeyConstraint(["order_id"], ["orders.id"], ondelete="SET NULL"),
        sa.ForeignKeyConstraint(["trade_id"], ["trades.id"], ondelete="CASCADE"),
        sa.ForeignKeyConstraint(["user_id"], ["users.id"], ondelete="SET NULL"),
        sa.PrimaryKeyConstraint("id"),
        sa.UniqueConstraint("trade_id", "version_number", name="uq_trade_id_version_number"),
    )
    op.create_index("ix_trade_version_trade_id", "trade_versions", ["trade_id"], unique=False)
    op.create_index(op.f("ix_trade_versions_id"), "trade_versions", ["id"], unique=False)
    op.create_index(op.f("ix_trade_versions_trade_id"), "trade_versions", ["trade_id"], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f("ix_trade_versions_trade_id"), table_name="trade_versions")
    op.drop_index(op.f("ix_trade_versions_id"), table_name="trade_versions")
    op.drop_index("ix_trade_version_trade_id", table_name="trade_versions")
    op.drop_table("trade_versions")
    op.drop_index(op.f("ix_strategy_versions_strategy_id"), table_name="strategy_versions")
    op.drop_index(op.f("ix_strategy_versions_id"), table_name="strategy_versions")
    op.drop_index("ix_strategy_version_strategy_id", table_name="strategy_versions")
    op.drop_table("strategy_versions")
    op.drop_index(op.f("ix_audit_logs_user_id"), table_name="audit_logs")
    op.drop_index(op.f("ix_audit_logs_timestamp"), table_name="audit_logs")
    op.drop_index(op.f("ix_audit_logs_table_name"), table_name="audit_logs")
    op.drop_index(op.f("ix_audit_logs_record_pk"), table_name="audit_logs")
    op.drop_index(op.f("ix_audit_logs_id"), table_name="audit_logs")
    op.drop_index(op.f("ix_audit_logs_action"), table_name="audit_logs")
    op.drop_index("ix_audit_log_user_action_timestamp", table_name="audit_logs")
    op.drop_index("ix_audit_log_table_record_timestamp", table_name="audit_logs")
    op.drop_table("audit_logs")
    # ### end Alembic commands ###
